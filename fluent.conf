<source>
  type tail
  format json
  time_key time
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  keep_time_key true
  tag reform.*
  read_from_head true
</source>

<match reform.**>
  type record_reformer
  enable_ruby true
  tag kubernetes.${tag_suffix[4].split('-')[0..-2].join('-')}
  <record>
    @timestamp ${Time.parse(record["time"]).strftime("%Y-%m-%dT%H:%M:%S.%L%z")}
  </record>

  ## The record "time" has the nanosecond precision, but kibana insists on sorting the fields by millisecond
  ## so we need this to be able to debug same-millisecond messages
  time_nano ${"%10.9f" % Time.parse(record["time"])}

</match>

<match kubernetes.fluentd-kube2es*>
  type null
</match>

<match kubernetes.**>
  @type copy

  <store>
    @type stdout
    @id stdout_output
  </store>

  <store>
    @type elasticsearch
    host 172.16.0.19
    port 9200
    logstash_format true
    logstash_prefix kubernetes
    include_tag_key true
    flush_interval 10s
  </store>

</match>
